/*!
 * Copyright (c) Christopher Keefer, 2015.
 * hup: V1.2.1.
 * Compiled: 2015-12-14 
 */


"use strict";!function(a){function b(a){this.init(a)}function c(b,c){return this.defer=a.Deferred(),this.promise=this.defer.promise(),this.file=c,this.options=b,this.paused=!1,this.progress=0,this.time={start:0,end:0,speed:0},this.xhr=new XMLHttpRequest,this.options.chunked&&(this.start=0,this.end=Math.min(this.start+this.options.chunk_size,this.file.size)),this.xhr.addEventListener("load",this.complete.bind(this),!1),this.xhr.upload.addEventListener("progress",this.uploadProgress.bind(this),!1),this.xhr.upload.addEventListener("error",this.uploadError.bind(this),!1),this.upload(),this}function d(b,c){return this.options=b,this.defer=a.Deferred(),this.promise=this.defer.promise(),this.reader=new FileReader,this.file=c,this.read_method=this.options.read_method,this.paused=!1,this.progress=0,this.options.chunked&&(this.start=0,this.end=this.calculateChunkEnd()),this.listen(),this.readFile(),this}var e={},f=[];!function(a){for(var b=a.split(/,/),c=[],d=0,g=b.length;g>d;d+=2){f.push(b[d]),c=b[d+1].split(/ /);for(var h=0,i=c.length;i>h;h++)e[c[h]]=b[d]}}("application/msword,doc dot,application/pdf,pdf,application/pgp-signature,pgp,application/postscript,ps ai eps,application/rtf,rtf,application/vnd.ms-excel,xls xlb,application/vnd.ms-powerpoint,ppt pps pot,application/zip,zip,application/x-shockwave-flash,swf swfl,application/x-javascript,js,application/json,json,audio/mpeg,mpga mpega mp2 mp3,audio/x-wav,wav,audio/mp4,m4a,image/bmp,bmp,image/gif,gif,image/jpeg,jpeg jpg jpe,image/photoshop,psd,image/png,png,image/svg+xml,svg svgz,image/tiff,tiff tif,text/plain,asc txt text diff log,text/html,htm html xhtml,text/css,css,text/csv,csv,text/rtf,rtf,video/mpeg,mpeg mpg mpe m2v,video/quicktime,qt mov,video/mp4,mp4,video/x-m4v,m4v,video/x-flv,flv,video/x-ms-wmv,wmv,video/avi,avi,video/webm,webm,video/3gpp,3gp,video/3gpp2,3g2,application/octet-stream,exe"),b.prototype.init=function(b){var c=this;this.options=a.extend({accept:[],async:!0,chunked:!0,chunk_size:1048576,input:"",make_dnd:!1,max_file_size:0,read_method:"readAsDataURL",type:"PUT",url:!1},b),this.input=a(this.options.input),this.options.accept=this.acceptFilters(this.options.accept),(this.options.make_dnd||!this.isFileInput(this.input))&&(this.options.make_dnd=!0,this.input.off("dragover").on("dragover",function(a){a=a.originalEvent,c.handleDragover(a)})),this.input.off("drop change").on("drop change",function(a){a=a.originalEvent,c.handleSelect(a)})},b.prototype.acceptFilters=function(a){var b,c,d=[];("string"==typeof a||a instanceof String)&&(a=a.split(/,/));for(var g=0,h=a.length;h>g;g++)if(b=a[g].trim().split(/\//),b.length>1)if("*"===b[1])for(var i=0,j=f.length;j>i;i++)c=f[i].split(/\//),b[0]===c[0]&&d.push(f[i]);else d.push(b.join("/"));else b[0]in e&&d.push(e[b[0]]);return d},b.prototype.isFileInput=function(a){return"INPUT"===a[0].tagName&&/file/i.test(a[0].getAttribute("type"))},b.prototype.handleDragover=function(a){a.preventDefault(),a.stopPropagation(),a.dataTransfer.dropEffect="copy"},b.prototype.handleSelect=function(a){var c;return this.options.make_dnd?(a.preventDefault(),a.stopPropagation(),c=a.dataTransfer.files):c=a.target.files,c.length?(this.input.trigger(b.state.FILE_LIST_LOADED,{state:b.state.FILE_LIST_LOADED,files:c}),void this.processFiles(c,this.options.url)):void this.input.trigger(b.state.FILE_LIST_ERROR,{state:b.state.FILE_LIST_ERROR,error:"No files found in file list; no files were selected."})},b.prototype.processFiles=function(a,e){var f,g=this,h=0,i=this.options.accept,j=!1,k=this.options.max_file_size;this.fprocessors=[];for(var l=0,m=a.length;m>l;l++){if(i.length){j=!1;for(var n=0,o=i.length;o>n&&!(j=a[l].type===i[n]);n++);if(!j){this.input.trigger(b.state.FILE_TYPE_ERROR,{state:b.state.FILE_TYPE_ERROR,file_name:a[l].name,error:"File type is "+a[l].type+", accepted types are "+i.join(",")+"."});continue}}k&&a[l].size>k?this.input.trigger(b.state.FILE_SIZE_ERROR,{state:b.state.FILE_SIZE_ERROR,file_name:a[l].name,error:"File size is "+a[l].size+", max file size is "+k+"."}):(f=e?new c(this.options,a[l]):new d(this.options,a[l]),f.promise.progress(function(a){g.input.trigger(a.state,a)}).done(function(a){if(g.input.trigger(a.state,a),h++,h>=m){if(e)return void g.input.trigger(b.state.FILE_UPLOAD_ALL,{state:b.state.FILE_UPLOAD_ALL,files:m});g.input.trigger(b.state.FILE_READ_ALL,{state:b.state.FILE_READ_ALL,files:m})}}).fail(function(a){g.input.trigger(a.state,a)}),this.fprocessors.push(f))}},b.prototype.pause=function(a){a=a?Array.isArray(a)?a:[a]:!1,this.fprocessors.forEach(function(b,c){return a?void((-1!==a.indexOf(c)||-1!==a.indexOf(b.file.name))&&b.pause()):void b.pause()})},b.prototype.resume=function(a){a=a?Array.isArray(a)?a:[a]:!1,this.fprocessors.forEach(function(b,c){return a?void((-1!==a.indexOf(c)||-1!==a.indexOf(b.file.name))&&b.resume()):void b.resume()})},b.prototype.reassembleChunkedDataURL=function(a){var b;arguments.length>1&&(a=Array.prototype.slice.call(arguments)),b=a[0];for(var c=1,d=a.length;d>c;c++)b+=a[c].split(",")[1];return b},b.state={FILE_LIST_ERROR:"fileListError",FILE_LIST_LOADED:"fileListLoaded",FILE_TYPE_ERROR:"fileTypeError",FILE_SIZE_ERROR:"fileSizeError",FILE_READ_ERROR:"fileReadError",FILE_READ_PROGRESS:"fileReadProgress",FILE_READ_FINISHED:"fileReadFinished",FILE_READ_PAUSE:"fileReadPause",FILE_READ_RESUME:"fileReadResume",FILE_READ_ALL:"fileReadAll",FILE_UPLOAD_ERROR:"fileUploadError",FILE_UPLOAD_PROGRESS:"fileUploadProgress",FILE_UPLOAD_PAUSE:"fileUploadPause",FILE_UPLOAD_RESUME:"fileUploadResume",FILE_UPLOAD_FINISHED:"fileUploadFinished",FILE_UPLOAD_ALL:"fileUploadAll"},c.prototype.upload=function(){this.time.start=+new Date,this.xhr.open(this.options.type,this.options.url,this.options.async),this.xhr.setRequestHeader("Accept","application/json"),this.xhr.setRequestHeader("X-File-Name",encodeURIComponent(this.file.name)),this.xhr.setRequestHeader("X-File-Type",this.file.type),this.options.chunked?(this.xhr.overrideMimeType("application/octet-stream"),this.xhr.setRequestHeader("Content-Range","bytes "+this.start+"-"+this.end+"/"+this.file.size),this.xhr.send(this.file.slice(this.start,this.end))):(this.xhr.overrideMimeType(this.file.type||"application/octet-stream"),this.xhr.send(this.file))},c.prototype.uploadProgress=function(a){a.lengthComputable&&(this.progress=a.loaded/a.total,this.options.chunked&&(this.progress*=this.end/this.file.size),this.time.end=+new Date,this.time.speed=this.file.size*this.progress/(this.time.end-this.time.start)*1e3,console.log("time:",this.time.end-this.time.start,"speed:",this.time.speed,"progress:",this.progress),this.defer.notify({state:b.state.FILE_UPLOAD_PROGRESS,file_name:this.file.name,speed:this.time.speed,progress:this.progress}))},c.prototype.uploadError=function(a){this.defer.reject({state:b.state.FILE_UPLOAD_ERROR,file_name:this.file.name,error:a})},c.prototype.complete=function(){return this.time.end=+new Date,this.options.chunked&&this.end!=this.file.size?(this.defer.notify({state:b.state.FILE_UPLOAD_PROGRESS,file_name:this.file.name,response:this.parseResponse(),progress:this.progress}),this.start=this.end,this.end=Math.min(this.start+this.options.chunk_size,this.file.size),void(this.paused||this.upload())):void this.uploadComplete()},c.prototype.uploadComplete=function(){this.defer.resolve({state:b.state.FILE_UPLOAD_FINISHED,file_name:this.file.name,file_size:this.file.size,file_type:this.file.type,response:this.parseResponse()})},c.prototype.parseResponse=function(){var a;try{a=JSON.parse(this.xhr.responseText)}catch(b){a={error:b,text:this.xhr.responseText}}return a},c.prototype.pause=function(){"pending"===this.defer.state()&&this.options.chunked&&(this.paused=!0,this.defer.notify({state:b.state.FILE_UPLOAD_PAUSE,file_name:this.file.name,current_range:{start:this.start,end:this.end,total:this.file.size}}))},c.prototype.resume=function(){this.options.chunked&&this.paused&&(this.paused=!1,this.defer.notify({state:b.state.FILE_UPLOAD_RESUME,file_name:this.file.name,current_range:{start:this.start,end:this.end,total:this.file.size}}),this.upload())},d.prototype.calculateChunkEnd=function(){var a=Math.min(this.start+this.options.chunk_size,this.file.size);return"readAsDataURL"===this.read_method&&a!==this.file.size&&(a-=a%6),a},d.prototype.readFile=function(){return this.options.chunked?void this.reader[this.read_method](this.file.slice(this.start,this.end,this.file.type)):void this.reader[this.read_method](this.file)},d.prototype.readProgress=function(a){var c=this.progress;a.lengthComputable&&(c=a.loaded/a.total,this.options.chunked&&(c*=this.end/this.file.size),this.defer.notify({state:b.state.FILE_READ_PROGRESS,file_name:this.file.name,progress:c})),this.progress=c},d.prototype.readComplete=function(a){return a.target.readyState!=FileReader.DONE||this.options.chunked&&this.end!=this.file.size?(this.defer.notify({state:b.state.FILE_READ_PROGRESS,file_name:this.file.name,progress:this.progress,read_result:a.target.readyState==FileReader.DONE?a.target.result:void 0}),this.start=this.end,this.end=this.calculateChunkEnd(),void(this.paused||this.readFile())):void this.defer.resolve({state:b.state.FILE_READ_FINISHED,file_name:this.file.name,file_size:this.file.size,file_type:this.file.type,read_method:this.read_method,read_result:a.target.result})},d.prototype.readError=function(a){var c=a.target.error,d=a.target.error.code,e='Error attempting to read file "'+this.file.name+'": ';switch(d){case c.NOT_FOUND_ERR:e+="File could not be found.";break;case c.NOT_READABLE_ERR:e+="File is not readable.";break;case c.ABORT_ERR:e+="File read was aborted.";break;default:e+="An unexpected error occurred."}this.defer.reject({state:b.state.FILE_READ_ERROR,file_name:this.file.name,error:e,code:d})},d.prototype.listen=function(){this.reader.addEventListener("error",this.readError.bind(this),!1),this.reader.addEventListener("progress",this.readProgress.bind(this),!1),this.reader.addEventListener("loadend",this.readComplete.bind(this),!1)},d.prototype.pause=function(){"pending"===this.defer.state()&&this.options.chunked&&(this.paused=!0,this.defer.notify({state:b.state.FILE_READ_PAUSE,file_name:this.file.name,current_range:{start:this.start,end:this.end,total:this.file.size}}))},d.prototype.resume=function(){this.options.chunked&&this.paused&&(this.paused=!1,this.defer.notify({state:b.state.FILE_READ_RESUME,file_name:this.file.name,current_range:{start:this.start,end:this.end,total:this.file.size}}),this.readFile())},a.fn.hup=function(c){return c=c||{},this.each(function(){c.input=this;var d=a(this),e=d.data("hup");e?e instanceof b&&e.init(c):d.data("hup",new b(c))})}}(jQuery);
//# sourceMappingURL=hup.min.map